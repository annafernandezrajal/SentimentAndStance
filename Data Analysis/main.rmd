##Testing R

Load libraries
```{r}
library(gplots)
library(ggplot2)
library(gridExtra)
library(grid)
library(likert)
library(ggnewscale)
library(caret)
library(pals)
library(yardstick)
```

Load data
```{r}
data <- read.csv("Data Analysis/dataset/output_test.csv")

##data <- read.csv("C:/Users/steem/Desktop/StudiesKTH/II2202 Research Methodology and Scientific Writing/SentimentAndStance/Data Analysis/dataset/output.csv")

data
```

Pre-process
```{r}
stance <- data$Stance
sentiment <- data$Sentiment
predicted_sentiment <- data$sentimentVader
predicted_stance <- data$StanceSVM

stance <- replace(stance, stance == "FAVOR", 1)
stance <- replace(stance, stance == "NONE", 0)
stance <- replace(stance, stance == "AGAINST", -1)
stance <- as.numeric(stance)

sentiment <- replace(sentiment, sentiment == "neg", -1)
sentiment <- replace(sentiment, sentiment == "other", 0)
sentiment <- replace(sentiment, sentiment == "pos", 1)
sentiment <- as.numeric(sentiment)

predicted_sentiment <- replace(predicted_sentiment, predicted_sentiment < 0, -1)
predicted_sentiment <- replace(predicted_sentiment, predicted_sentiment > 0, 1)
predicted_sentiment <- as.numeric(predicted_sentiment)

predicted_stance <- replace(predicted_stance, predicted_stance == "FAVOR", 1)
predicted_stance <- replace(predicted_stance, predicted_stance == "NONE", 0)
predicted_stance <- replace(predicted_stance, predicted_stance == "AGAINST", -1)
predicted_stance <- as.numeric(predicted_stance)

data$Stance <- stance
data$Sentiment <- sentiment
data$sentimentVader <- predicted_sentiment
data$StanceSVM <- predicted_stance
```

Visualization
```{r}
# Based on DanO's answer on https://stackoverflow.com/questions/61504970/ggplot2-heatmap-2-different-color-schemes-confusion-matrix-matches-in-differe but with several fixes
plot.plotWithDiagonalMarked <- function(confusionMatrix, xlabel, ylabel) {
  confusionMatrix_diagonalMarked <- as.data.frame(confusionMatrix$table)
  confusionMatrix_diagonalMarked$diag <- confusionMatrix_diagonalMarked$Prediction == confusionMatrix_diagonalMarked$Reference # Get the diagonal
  confusionMatrix_diagonalMarked[confusionMatrix_diagonalMarked$Freq == 0] <- NA # If an tile is empty, mark it is NA so we can give it another color
  confusionMatrix_diagonalMarked$Reference <- reverse.levels(confusionMatrix_diagonalMarked$Reference) # diagonal starts at top left
  confusionMatrix_diagonalMarked$ref_freq <- confusionMatrix_diagonalMarked$Freq * ifelse(confusionMatrix_diagonalMarked$diag, 1, -1) # flip sign for non-diagonal values
  # confusionMatrix_diagonalMarked$ref_freq <- scale(confusionMatrix_diagonalMarked$ref_freq) # normalize values
  confusionMatrix_diagonalMarked$ref_freq <- confusionMatrix_diagonalMarked$ref_freq + max(confusionMatrix_diagonalMarked$Freq) + min(confusionMatrix_diagonalMarked$Freq)  # This for some reason fixes the colour range not being scaled properly, found by experimentation

  print(confusionMatrix_diagonalMarked)

  # plotting the matrix
  confusionMatrix_diagonalMarked_plot <- ggplot(data = confusionMatrix_diagonalMarked, aes(x = Prediction, y = Reference, fill = Freq)) +
          xlab(xlabel) +
          ylab(ylabel) +
          scale_x_discrete(position = "top") +
          geom_tile(data = confusionMatrix_diagonalMarked, aes(fill = ref_freq)) +
          scale_fill_gradientn(guide = FALSE, colours=c("red", "white", "#D6EAF8", "#2E86C1"), values=scales::rescale(c(-1, 0, 0.001, 1)), na.value="white") +
          geom_text(aes(label = Freq), color = 'black', size = 6) +
          coord_equal() +
          theme_light() +
          theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
                legend.position = "none",
                panel.border = element_blank(),
                plot.background = element_blank(),
                axis.line = element_blank())
  return(confusionMatrix_diagonalMarked_plot)
}
```


EXPERIMENTS

Experiment 1) How does sentiment analysis perform compared to the ground-truth?
```{r}
cat(sum(sentiment == predicted_sentiment) / length(sentiment), "% accuracy", sep = '')

vader_ground <- data.frame(
  Prediction = data$sentimentVader,
  Reference = data$Sentiment
)

vader_ground$Reference[vader_ground$Reference == 0] <- "Neutral"
vader_ground$Prediction[vader_ground$Prediction == 0] <- "Neutral"
vader_ground$Reference[vader_ground$Reference == 1] <- "Positive"
vader_ground$Prediction[vader_ground$Prediction == 1] <- "Positive"
vader_ground$Reference[vader_ground$Reference == -1] <- "Negative"
vader_ground$Prediction[vader_ground$Prediction == -1] <- "Negative"

vader_ground$Reference <- as.factor(vader_ground$Reference)
vader_ground$Prediction <- as.factor(vader_ground$Prediction)

confusionMatrix <- caret::confusionMatrix(vader_ground$Prediction, vader_ground$Reference)

plot <- plot.plotWithDiagonalMarked(confusionMatrix, 'VADER sentiment', 'Actual sentiment')
plot
ggsave("Data Analysis/images/VaderGroundTruthHeatmap.png")
```

Experiment 2) How does stance detection perform compared to the ground-truth?
```{r}
cat(sum(stance == predicted_stance) / length(stance),  "% accuracy", sep = '')

stance_ground <- data.frame(
  Prediction = data$StanceSVM,
  Reference = data$Stance
)

stance_ground$Reference[stance_ground$Reference == 1] <- "FAVOR"
stance_ground$Prediction[stance_ground$Prediction == 1] <- "FAVOR"
stance_ground$Reference[stance_ground$Reference == 0] <- "NONE"
stance_ground$Prediction[stance_ground$Prediction == 0] <- "NONE"
stance_ground$Reference[stance_ground$Reference == -1] <- "AGAINST"
stance_ground$Prediction[stance_ground$Prediction == -1] <- "AGAINST"

stance_ground$Reference <- as.factor(stance_ground$Reference)
stance_ground$Prediction <- as.factor(stance_ground$Prediction)

confusionMatrix <- caret::confusionMatrix(stance_ground$Prediction, stance_ground$Reference)

plot <- plot.plotWithDiagonalMarked(confusionMatrix, 'SVM stance', 'Actual stance')
plot
ggsave("Data Analysis/images/StanceSVMGroundTruthHeatmap.png")
```

Experiment 3) How much overlap is there between ground-truth sentiment and stance?
```{r}
cat(sum(stance == sentiment) / length(stance), "% overlap", sep = '')

ground_sentiment_stance <- data.frame(
  Sentiment = data$Sentiment,
  Stance = data$Stance
)

ground_sentiment_stance$Sentiment[ground_sentiment_stance$Sentiment == 0] <- "Neutral"
ground_sentiment_stance$Stance[ground_sentiment_stance$Stance == 0] <- "Neutral"
ground_sentiment_stance$Sentiment[ground_sentiment_stance$Sentiment == 1] <- "Positive"
ground_sentiment_stance$Stance[ground_sentiment_stance$Stance == 1] <- "Positive"
ground_sentiment_stance$Sentiment[ground_sentiment_stance$Sentiment == -1] <- "Negative"
ground_sentiment_stance$Stance[ground_sentiment_stance$Stance == -1] <- "Negative"

ground_sentiment_stance$Sentiment <- as.factor(ground_sentiment_stance$Sentiment)
ground_sentiment_stance$Stance <- as.factor(ground_sentiment_stance$Stance)

confusionMatrix <- caret::confusionMatrix(ground_sentiment_stance$Stance, ground_sentiment_stance$Sentiment)

plot <- plot.plotWithDiagonalMarked(confusionMatrix, 'Actual sentiment', 'Actual stance')
plot
ggsave("Data Analysis/images/GroundTruthSentimentStance.png")
```

Experiment 4) How much overlap is there between sentiment and stance?

Experiment 5) How do values for sentiment map to values for stance (with bucket sizes of 0.2)?






